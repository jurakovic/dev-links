<script>
    function loadAllPosts(feedNames, rootId) {
        // Returns a promise for each feed
        const fetchPromises = feedNames.map(name =>
            fetch(`/dev-links/posts/${name}.json`)
                .then(response => response.json())
                .then(items => items.map(item => ({ ...item, feed: name }))) // Tag each post with its feed name
                .catch(() => []) // On error, return empty array for that feed
        );

        Promise.all(fetchPromises)
            .then(allResults => {
                // Flatten all items into a single array
                const allItems = allResults.flat();

                // Sort by full pubDate (descending: newest first)
                allItems.sort((a, b) => {
                    const aDate = new Date(a.pubDate);
                    const bDate = new Date(b.pubDate);
                    return bDate - aDate; // descending
                });

                const root = document.getElementById(rootId);
                if (!root) return;

                root.innerHTML = '';

                // Create unordered list
                const ul = document.createElement('ul');
                ul.style.listStyleType = 'none';
                ul.style.padding = '0';
                ul.style.margin = '0';

                allItems.forEach(item => {
                    // Format date as YYYY-MM-DD
                    let dateStr = '';
                    if (item.pubDate) {
                        const dateObj = new Date(item.pubDate);
                        if (!isNaN(dateObj)) {
                            const yyyy = dateObj.getFullYear();
                            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const dd = String(dateObj.getDate()).padStart(2, '0');
                            dateStr = `${yyyy}-${mm}-${dd}`;
                        }
                    }

                    const li = document.createElement('li');
                    li.style.padding = '2px 0';
                    li.style.whiteSpace = 'nowrap';

                    // Favico img
                    const img = document.createElement('img');
                    img.src = `/dev-links/favicons/${item.feed}.png`;
                    img.alt = 'icon';
                    img.style.width = '16px';
                    img.style.height = '16px';
                    img.style.verticalAlign = 'middle';
                    img.style.marginRight = '6px';
                    li.appendChild(img);

                    // Date
                    if (dateStr) {
                        const dateSpan = document.createElement('span');
                        dateSpan.textContent = dateStr;
                        dateSpan.style.marginRight = '6px';
                        li.appendChild(dateSpan);
                    }

                    // Anchor
                    const a = document.createElement('a');
                    a.href = item.link;
                    a.textContent = item.title;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.style.whiteSpace = 'nowrap';
                    a.style.display = 'inline-block';
                    li.appendChild(a);

                    ul.appendChild(li);
                });

                root.appendChild(ul);
            })
            .catch(error => {
                console.error('Failed to load all posts:', error);
            });
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadAllPosts(['dotnet', 'visualstudio'], 'reader');
    });
</script>
